<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>深入理解 Cilium 的 eBPF 收发包路径（datapath） | ryancoding</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/logo.jpg">
    <link rel="stylesheet" href="/css/style.css">
    <script>var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?3ab3d4cf25cd3fd346f82c4395a685c6";
          var s = document.getElementsByTagName("script")[0]; 
          s.parentNode.insertBefore(hm, s);
        })();</script>
    <meta name="description" content="继往圣之绝学，为万世开太平">
    
    <link rel="preload" href="/assets/css/0.styles.a035a541.css" as="style"><link rel="preload" href="/assets/js/app.c3a3c59f.js" as="script"><link rel="preload" href="/assets/js/3.fffc709b.js" as="script"><link rel="preload" href="/assets/js/1.b1aed609.js" as="script"><link rel="preload" href="/assets/js/4.b8b133d8.js" as="script"><link rel="prefetch" href="/assets/js/10.1dd51d14.js"><link rel="prefetch" href="/assets/js/11.d70db5b4.js"><link rel="prefetch" href="/assets/js/12.d4164505.js"><link rel="prefetch" href="/assets/js/13.192ef96b.js"><link rel="prefetch" href="/assets/js/14.282ffb3c.js"><link rel="prefetch" href="/assets/js/15.9e5ad7c8.js"><link rel="prefetch" href="/assets/js/16.300f3fcd.js"><link rel="prefetch" href="/assets/js/17.9e91194c.js"><link rel="prefetch" href="/assets/js/18.4ccbadb1.js"><link rel="prefetch" href="/assets/js/19.bfd45861.js"><link rel="prefetch" href="/assets/js/20.ced223c7.js"><link rel="prefetch" href="/assets/js/21.d65b9f87.js"><link rel="prefetch" href="/assets/js/22.9902d513.js"><link rel="prefetch" href="/assets/js/23.6e2fba95.js"><link rel="prefetch" href="/assets/js/24.28b91084.js"><link rel="prefetch" href="/assets/js/5.35a9b107.js"><link rel="prefetch" href="/assets/js/6.47f738ff.js"><link rel="prefetch" href="/assets/js/7.5aa4e347.js"><link rel="prefetch" href="/assets/js/8.2a018639.js"><link rel="prefetch" href="/assets/js/9.39c5b16f.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a035a541.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-1aefc0b4><div data-v-1aefc0b4><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-1aefc0b4 data-v-1aefc0b4><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-25ba6db2 data-v-1aefc0b4 data-v-1aefc0b4><h3 class="title" data-v-25ba6db2 data-v-25ba6db2>ryancoding</h3> <p class="description" data-v-25ba6db2 data-v-25ba6db2>继往圣之绝学，为万世开太平</p> <label id="box" class="inputBox" data-v-25ba6db2 data-v-25ba6db2><input type="password" value="" data-v-25ba6db2> <span data-v-25ba6db2>Konck! Knock!</span> <button data-v-25ba6db2>OK</button></label> <div class="footer" data-v-25ba6db2 data-v-25ba6db2><span data-v-25ba6db2><i class="iconfont reco-theme" data-v-25ba6db2></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-25ba6db2>vuePress-theme-reco</a></span> <span data-v-25ba6db2><i class="iconfont reco-copyright" data-v-25ba6db2></i> <a data-v-25ba6db2><span data-v-25ba6db2>Ryan</span>
            
          <span data-v-25ba6db2>2022 - </span>
          2024
        </a></span></div></div> <div class="hide" data-v-1aefc0b4><header class="navbar" data-v-1aefc0b4><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.jpg" alt="ryancoding" class="logo"> <span class="site-name">ryancoding</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/算法/" class="nav-link"><i class="undefined"></i>
  算法
</a></li><li class="dropdown-item"><!----> <a href="/categories/ebpf/" class="nav-link"><i class="undefined"></i>
  ebpf
</a></li><li class="dropdown-item"><!----> <a href="/categories/perf/" class="nav-link"><i class="undefined"></i>
  perf
</a></li><li class="dropdown-item"><!----> <a href="/categories/wireguard/" class="nav-link"><i class="undefined"></i>
  wireguard
</a></li><li class="dropdown-item"><!----> <a href="/categories/clangd/" class="nav-link"><i class="undefined"></i>
  clangd
</a></li><li class="dropdown-item"><!----> <a href="/categories/linux/" class="nav-link"><i class="undefined"></i>
  linux
</a></li><li class="dropdown-item"><!----> <a href="/categories/流量监控/" class="nav-link"><i class="undefined"></i>
  流量监控
</a></li><li class="dropdown-item"><!----> <a href="/categories/IP路由/" class="nav-link"><i class="undefined"></i>
  IP路由
</a></li><li class="dropdown-item"><!----> <a href="/categories/vpn/" class="nav-link"><i class="undefined"></i>
  vpn
</a></li><li class="dropdown-item"><!----> <a href="/categories/Sectran/" class="nav-link"><i class="undefined"></i>
  Sectran
</a></li><li class="dropdown-item"><!----> <a href="/categories/RDP/" class="nav-link"><i class="undefined"></i>
  RDP
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间轴
</a></div><div class="nav-item"><a href="/about/" class="nav-link"><i class="iconfont reco-account"></i>
  关于我
</a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-1aefc0b4></div> <aside class="sidebar" data-v-1aefc0b4><div class="personal-info-wrapper" data-v-39576ba9 data-v-1aefc0b4><img src="/img/avatar.png" alt="author-avatar" class="personal-img" data-v-39576ba9> <h3 class="name" data-v-39576ba9>
    Ryan
  </h3> <div class="num" data-v-39576ba9><div data-v-39576ba9><h3 data-v-39576ba9>14</h3> <h6 data-v-39576ba9>Articles</h6></div> <div data-v-39576ba9><h3 data-v-39576ba9>0</h3> <h6 data-v-39576ba9>Tags</h6></div></div> <ul class="social-links" data-v-39576ba9></ul> <hr data-v-39576ba9></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/算法/" class="nav-link"><i class="undefined"></i>
  算法
</a></li><li class="dropdown-item"><!----> <a href="/categories/ebpf/" class="nav-link"><i class="undefined"></i>
  ebpf
</a></li><li class="dropdown-item"><!----> <a href="/categories/perf/" class="nav-link"><i class="undefined"></i>
  perf
</a></li><li class="dropdown-item"><!----> <a href="/categories/wireguard/" class="nav-link"><i class="undefined"></i>
  wireguard
</a></li><li class="dropdown-item"><!----> <a href="/categories/clangd/" class="nav-link"><i class="undefined"></i>
  clangd
</a></li><li class="dropdown-item"><!----> <a href="/categories/linux/" class="nav-link"><i class="undefined"></i>
  linux
</a></li><li class="dropdown-item"><!----> <a href="/categories/流量监控/" class="nav-link"><i class="undefined"></i>
  流量监控
</a></li><li class="dropdown-item"><!----> <a href="/categories/IP路由/" class="nav-link"><i class="undefined"></i>
  IP路由
</a></li><li class="dropdown-item"><!----> <a href="/categories/vpn/" class="nav-link"><i class="undefined"></i>
  vpn
</a></li><li class="dropdown-item"><!----> <a href="/categories/Sectran/" class="nav-link"><i class="undefined"></i>
  Sectran
</a></li><li class="dropdown-item"><!----> <a href="/categories/RDP/" class="nav-link"><i class="undefined"></i>
  RDP
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间轴
</a></div><div class="nav-item"><a href="/about/" class="nav-link"><i class="iconfont reco-account"></i>
  关于我
</a></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-25ba6db2 data-v-1aefc0b4><h3 class="title" data-v-25ba6db2 data-v-25ba6db2>深入理解 Cilium 的 eBPF 收发包路径（datapath）</h3> <!----> <label id="box" class="inputBox" data-v-25ba6db2 data-v-25ba6db2><input type="password" value="" data-v-25ba6db2> <span data-v-25ba6db2>Konck! Knock!</span> <button data-v-25ba6db2>OK</button></label> <div class="footer" data-v-25ba6db2 data-v-25ba6db2><span data-v-25ba6db2><i class="iconfont reco-theme" data-v-25ba6db2></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-25ba6db2>vuePress-theme-reco</a></span> <span data-v-25ba6db2><i class="iconfont reco-copyright" data-v-25ba6db2></i> <a data-v-25ba6db2><span data-v-25ba6db2>Ryan</span>
            
          <span data-v-25ba6db2>2022 - </span>
          2024
        </a></span></div></div> <div data-v-1aefc0b4><main class="page"><section><div class="page-title"><h1 class="title">深入理解 Cilium 的 eBPF 收发包路径（datapath）</h1> <div data-v-f875f3fc><i class="iconfont reco-account" data-v-f875f3fc><span data-v-f875f3fc>Ryan</span></i> <i class="iconfont reco-date" data-v-f875f3fc><span data-v-f875f3fc>7/18/2023</span></i> <!----> <!----></div></div> <div class="theme-reco-content content__default"><p></p><div class="table-of-contents"><ul><li><a href="#译者序">译者序</a></li></ul></div><p></p> <h3 id="译者序"><a href="#译者序" class="header-anchor">#</a> 译者序</h3> <p>本文翻译DigitalOcean 的工程师 Nate Sweet 在 KubeCon 的一篇分享</p> <hr> <h1 id="_1-为什么要关注-ebpf"><a href="#_1-为什么要关注-ebpf" class="header-anchor">#</a> 1 为什么要关注 eBPF？</h1> <h2 id="_1-1-网络成为瓶颈"><a href="#_1-1-网络成为瓶颈" class="header-anchor">#</a> 1.1 网络成为瓶颈</h2> <p>大家已经知道网络成为瓶颈，但我是从下面这个角度考虑的：<strong>近些年业界使用网络的方式 ，使其成为瓶颈</strong>（it is the bottleneck in a way that is actually pretty recent） 。</p> <ul><li><strong>网络一直都是 I/O 密集型的</strong>，但直到最近，这件事情才变得尤其重要。</li> <li><strong>分布式任务（workloads）业界一直都在用</strong>，但直到近些年，这种模型才成为主流。 虽然何时成为主流众说纷纭，但我认为最早不会早于 90 年代晚期。</li> <li><strong>公有云的崛起</strong>，我认为可能是网络成为瓶颈的最主要原因。</li></ul> <p>这种情况下，用于管理依赖和解决瓶颈的<strong>工具都已经过时了</strong>。</p> <p>但像 eBPF 这样的技术使得网络调优和整流（tune and shape this traffic）变得简单很多。 <strong>eBPF 提供的许多能力是其他工具无法提供的，或者即使提供了，其代价也要比 eBPF 大 的多</strong>。</p> <h2 id="_1-2-ebpf-无处不在"><a href="#_1-2-ebpf-无处不在" class="header-anchor">#</a> 1.2 eBPF 无处不在</h2> <p>eBPF 正在变得无处不在，我们可能会争论这到底是一件好事还是坏事（eBPF 也确实带了一 些安全问题），但当前无法忽视的事实是：Linux 内核的网络开发者们<strong>正在将 eBPF 应用 于各种地方</strong>（putting it everywhere）。其结果是，eBPF <strong>与内核的默认收发包路径（ datapath）耦合得越来越紧</strong>（more and more tightly coupled with the default datapath）。</p> <h2 id="_1-3-性能就是金钱"><a href="#_1-3-性能就是金钱" class="header-anchor">#</a> 1.3 性能就是金钱</h2> <p><a href="https://kernel-recipes.org/en/2019/metrics-are-money/" target="_blank" rel="noopener noreferrer">“Metrics are money”<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>， 这是今年 Paris Kernel Recipes 峰会上，来自 Synthesio 的 Aurelian Rougemont 的 精彩分享。</p> <p>他展示了一些史诗级的调试（debugging）案例，感兴趣的可以去看看；但更重要的是，他 从更高层次提出了这样一个观点：<strong>理解这些东西是如何工作的，最终会产生资本收益</strong>（ understanding how this stuff works translates to money）。为客户节省金钱，为 自己带来收入。</p> <p>如果你能从更少的资源中榨取出更高的性能，使软件运行更快，那 显然你对公司的贡献就更大。<strong>Cilium 就是这样一个能让你带来更大价值的工具</strong>。</p> <p>在进一步讨论之前，我先简要介绍一下 eBPF 是什么，以及为什么它如此强大。</p> <h1 id="_2-ebpf-是什么"><a href="#_2-ebpf-是什么" class="header-anchor">#</a> 2 eBPF 是什么？</h1> <p><strong>BPF 程序有多种类型</strong>，图 2.1 是其中一种，称为 XDP BPF 程序。</p> <ul><li>XDP 是 <strong>eXpress DataPath</strong>（特快数据路径）。</li> <li>XDP 程序可以直接<strong>加载到网络设备上</strong>。</li> <li>XDP 程序在数据包收发路径上<strong>很前面的位置</strong>就开始执行，下面会看到例子。</li></ul> <p>BPF 程序开发方式：</p> <ol><li><strong>编写</strong>一段 BPF 程序</li> <li><strong>编译</strong>这段 BPF 程序</li> <li>用一个特殊的系统调用将编译后的代码<strong>加载到内核</strong></li></ol> <p><strong>这实际上就是编写了一段内核代码，并动态插入到了内核</strong>（written kernel code and dynamically inserted it into the kernel）。</p> <p><img src="/assets/img/ebpf-sample.0cd0a585.png" alt="img"></p> <p>图 2.1. eBPF 代码示例：丢弃源 IP 命中黑名单的 ARP 包</p> <p>图 2.1 中的程序使用了一种称为 <strong>map</strong> 的东西，这是一种特殊的数据结构，可用于 <strong>在内核和用户态之间传递数据</strong>，例如通过一个特殊的系统从用户态向 map 里插入数据。</p> <p>这段程序的功能：丢弃所有源 IP 命中黑名单的 ARP 包。右侧四个框内的代码功能：</p> <ol><li>初始化以太帧结构体（ethernet packet）。</li> <li>如果不是 ARP 包，直接退出，将包交给内核继续处理。</li> <li>至此已确定是 ARP，因此初始化一个 ARP 数据结构，对包进行下一步处理。例 如，提取出 ARP 中的源 IP，去之前创建好的黑名单中查询该 IP 是否存在。</li> <li>如果存在，返回丢弃判决（<code>XDP_DROP</code>）；否则，返回允许通行判决（ <code>XDP_PASS</code>），内核会进行后续处理。</li></ol> <p>你可能不会相信，就这样一段简单的程序，会让服务器性能产生质的飞跃，因为它此时已 经拥有了一条极为高效的网络路径（an extremely efficient network path）。</p> <h1 id="_3-为什么-ebpf-如此强大"><a href="#_3-为什么-ebpf-如此强大" class="header-anchor">#</a> 3 为什么 eBPF 如此强大？</h1> <p>三方面原因：</p> <ol><li>快速（fast）</li> <li>灵活（flexible）</li> <li>数据与功能分离（separates data from functionality）</li></ol> <h2 id="_3-1-快速"><a href="#_3-1-快速" class="header-anchor">#</a> 3.1 快速</h2> <p>eBPF 几乎总是比 iptables 快，这是有技术原因的。</p> <ul><li>eBPF 程序本身并不比 iptables 快，但 eBPF 程序更短。</li> <li>iptables 基于一个非常庞大的内核框架（Netfilter），这个框架出现在内核 datapath 的多个地方，有很大冗余。</li></ul> <p>因此，同样是实现 ARP drop 这样的功能，基于 iptables 做冗余就会非常大，导致性能很低。</p> <h2 id="_3-2-灵活"><a href="#_3-2-灵活" class="header-anchor">#</a> 3.2 灵活</h2> <p>这可能是最主要的原因。<strong>你可以用 eBPF 做几乎任何事情</strong>。</p> <p>eBPF 基于内核提供的一组接口，运行 JIT 编译的字节码，并将计算结果返回给内核。例如 <strong>内核只关心 XDP 程序的返回是 PASS, DROP 还是 REDIRECT。至于在 XDP 程序里做什么， 完全看你自己</strong>。</p> <h2 id="_3-3-数据与功能分离"><a href="#_3-3-数据与功能分离" class="header-anchor">#</a> 3.3 数据与功能分离</h2> <p>eBPF separates data from functionality.</p> <p><code>nftables</code> 和 <code>iptables</code> 也能干这个事情，但功能没有 eBPF 强大。例如，eBPF 可以使 用 per-cpu 的数据结构，因此能取得更极致的性能。</p> <p><strong>eBPF 真正的优势</strong>是将“数据与功能分离”这件事情做地<strong>非常干净</strong>（clean separation）：可以在 eBPF 程序不中断的情况下修改它的运行方式。具体方式是修改它访 问的配置数据或应用数据，例如黑名单里规定的 IP 列表和域名。</p> <p><img src="/assets/img/1.4a7b9d17.png" alt="img"></p> <h1 id="_4-ebpf-简史"><a href="#_4-ebpf-简史" class="header-anchor">#</a> 4 eBPF 简史</h1> <p>这里是简单介绍几句，后面 datapath 才是重点。</p> <p>两篇论文，可读性还是比较好的，感兴趣的自行阅读：</p> <ul><li>Steven McCanne, et al, in 1993 - <strong>The BSD Packet Filter</strong></li> <li>Jeffrey C. Mogul, et al, in 1987 - first open source implementation of a packet filter.</li></ul> <h1 id="_5-cilium-是什么-为什么要关注它"><a href="#_5-cilium-是什么-为什么要关注它" class="header-anchor">#</a> 5 Cilium 是什么，为什么要关注它？</h1> <p>我认为理解 eBPF 代码还比较简单，多看看内核代码就行了，但配置和编写 eBPF 就要难多了。</p> <p>Cilium 是一个很好的 eBPF 之上的通用抽象，覆盖了分布式系统的绝大多数场景。Cilium 封装了 eBPF，提供一个更上层的 API。如果你使用的是 Kubernetes，那你至少应该听说过 Cilium。</p> <p>Cilium 提供了 CNI 和 kube-proxy replacement 功能，相比 iptables 性能要好很多。</p> <p>接下来开始进入本文重点。</p> <h1 id="_6-内核默认-datapath"><a href="#_6-内核默认-datapath" class="header-anchor">#</a> 6 内核默认 datapath</h1> <p>本节将介绍<strong>数据包是如何穿过 network datapath（网络数据路径）的</strong>：包括从硬件到 内核，再到用户空间。</p> <p>这里将只介绍 <strong>Cilium 所使用的 eBPF 程序</strong>，其中有 Cilium logo 的地方，都是 datapath 上 Cilium 重度使用 BPF 程序的地方。</p> <p>本文不会过多介绍硬件相关内容，因为理解 eBPF 基本不需要硬件知识，但显然理解了硬件 原理也并无坏处。另外，由于时间限制，我将只讨论接收部分。</p> <h2 id="_6-1-l1-l2-物理层-数据链路层"><a href="#_6-1-l1-l2-物理层-数据链路层" class="header-anchor">#</a> 6.1 L1 -&gt; L2（物理层 -&gt; 数据链路层）</h2> <p><img src="/assets/img/dp-l1-l2.4bcccf24.png" alt="img"></p> <p>网卡收包简要流程：</p> <ol><li>网卡驱动初始化。
<ol><li>网卡获得一块物理内存，作用收发包的缓冲区（ring-buffer）。这种方式称为 DMA（直接内存访问）。</li> <li>驱动向内核 NAPI（New API）注册一个轮询（poll ）方法。</li></ol></li> <li>网卡从云上收到一个包，将包放到 ring-buffer。</li> <li>如果此时 NAPI 没有在执行，网卡就会触发一个硬件中断（HW IRQ），告诉处理器 DMA 区域中有包等待处理。</li> <li>收到硬中断信号后，处理器开始执行 NAPI。</li> <li>NAPI 执行网卡注册的 poll 方法开始收包。</li></ol> <p>关于 NAPI poll 机制：</p> <ul><li>这是 Linux 内核中的一种通用抽象，任何等待<strong>不可抢占状态</strong>发生（wait for a preemptible state to occur）的模块，都可以使用这种注册回调函数的方式。</li> <li>驱动注册的这个 poll 是一个<strong>主动式 poll</strong>（active poll），一旦执行就会持续处理 ，直到没有数据可供处理，然后进入 idle 状态。</li> <li>在这里，执行 poll 方法的是运行在某个或者所有 CPU 上的<strong>内核线程</strong>（kernel thread）。 虽然这个线程没有数据可处理时会进入 idle 状态，但如前面讨论的，在当前大部分分布 式系统中，这个线程大部分时间内都是在运行的，不断从驱动的 DMA 区域内接收数据包。</li> <li>poll 会告诉网卡不要再触发硬件中断，使用<strong>软件中断</strong>（softirq）就行了。此后这些 内核线程会轮询网卡的 DMA 区域来收包。之所以会有这种机制，是因为硬件中断代价太 高了，因为它们比系统上几乎所有东西的优先级都要高。</li></ul> <p>我们接下来还将多次看到这个广义的 NAPI 抽象，因为它不仅仅处理驱动，还能处理许多 其他场景。内核用 NAPI 抽象来做驱动读取（driver reads）、epoll 等等。</p> <p>NAPI 驱动的 poll 机制将数据从 DMA 区域读取出来，对数据做一些准备工作，然后交给比 它更上一层的内核协议栈。</p> <h2 id="_6-2-l2-续-数据链路层-续"><a href="#_6-2-l2-续-数据链路层-续" class="header-anchor">#</a> 6.2 L2 续（数据链路层 - 续）</h2> <p>同样，这里不会深入展开驱动层做的事情，而主要关注内核所做的一些更上层的事情，例如</p> <ul><li>分配 socket buffers（skb）</li> <li>BPF</li> <li>iptables</li> <li>将包送到网络栈（network stack）和用户空间</li></ul> <h3 id="step-1-napi-poll"><a href="#step-1-napi-poll" class="header-anchor">#</a> Step 1：NAPI poll</h3> <p><img src="/assets/img/dp-highlight-driver-poll.c9b96949.png" alt="img"></p> <p>首先，NAPI poll 机制不断调用驱动实现的 poll 方法，后者处理 RX 队列内的包，并最终 将包送到正确的程序。这就到了我们前面的 XDP 类型程序。</p> <h3 id="step-2-xdp-程序处理"><a href="#step-2-xdp-程序处理" class="header-anchor">#</a> Step 2：XDP 程序处理</h3> <p><img src="/assets/img/dp-highlight-xdp.602962d5.png" alt="img"></p> <p><strong>如果驱动支持 XDP，那 XDP 程序将在 poll 机制内执行</strong>。如果不支持，那 XDP 程序将只能<strong>在更后面执行</strong>（run significantly upstack，见 Step 6），性能会变差， 因此确定你使用的网卡是否支持 XDP 非常重要。</p> <p>XDP 程序返回一个判决结果给驱动，可以是 PASS, TRANSMIT, 或 DROP。</p> <ul><li>Transmit 非常有用，有了这个功能，就可以用 XDP <strong>实现一个 TCP/IP 负载均衡器</strong>。 XDP <strong>只适合对包进行较小修改</strong>，如果是大动作修改，那这样的 XDP 程序的性能 可能并不会很高，因为这些操作会<strong>降低 poll 函数处理 DMA ring-buffer 的能力</strong>。</li> <li>更有趣的是 DROP 方法，因为一旦判决为 DROP，这个包就可以直接<strong>原地丢弃</strong>了，而 无需再穿越后面复杂的协议栈然后再在某个地方被丢弃，从而节省了大量资源。如果本次 分享我只能给大家一个建议，那这个建议就是：<strong>在 datapath 越前面做 tuning 和 dropping 越好</strong>，这会显著增加系统的网络吞吐。</li> <li>如果返回是 PASS，内核会继续沿着默认路径处理包，到达 <code>clean_rx()</code> 方法。</li></ul> <h3 id="step-3-clean-rx-创建-skb"><a href="#step-3-clean-rx-创建-skb" class="header-anchor">#</a> Step 3：<code>clean_rx()</code>：创建 skb</h3> <p><img src="/assets/img/dp-highlight-clean-rx.87fb9cd3.png" alt="img"></p> <p>如果返回是 PASS，内核会继续沿着默认路径处理包，到达 <code>clean_rx()</code> 方法。</p> <p>这个方法<strong>创建一个 socket buffer（skb）对象</strong>，可能还会更新一些统计信息，对 skb 进行硬件校验和检查，然后将其交给 <code>gro_receive()</code> 方法。</p> <h3 id="step-4-gro-receive"><a href="#step-4-gro-receive" class="header-anchor">#</a> Step 4：<code>gro_receive()</code></h3> <p><img src="/assets/img/dp-highlight-gro.07dc73e9.png" alt="img"></p> <p>GRO 是一种较老的硬件特性（LRO）的软件实现，功能是<strong>对分片的包进行重组然后交给更 上层</strong>，以提高吞吐。</p> <p>GRO 给协议栈提供了一次<strong>将包交给网络协议栈之前，对其检查校验和 、修改协议头和发送应答包（ACK packets）的机会</strong>。</p> <ol><li>如果 GRO 的 buffer 相比于包太小了，它可能会选择什么都不做。</li> <li>如果当前包属于某个更大包的一个分片，调用 <code>enqueue_backlog</code> 将这个分片放到某个 CPU 的包队列。当包重组完成后，会交给 <code>receive_skb()</code> 方法处理。</li> <li>如果当前包不是分片包，直接调用 <code>receive_skb()</code>，进行一些网络栈最底层的处理。</li></ol> <h3 id="step-5-receive-skb"><a href="#step-5-receive-skb" class="header-anchor">#</a> Step 5：<code>receive_skb()</code></h3> <p><img src="/assets/img/dp-highlight-receive-skb.80b4a2e8.png" alt="img"></p> <p><code>receive_skb()</code> 之后会再次进入 XDP 程序点。</p> <h2 id="_6-3-l2-l3-数据链路层-网络层"><a href="#_6-3-l2-l3-数据链路层-网络层" class="header-anchor">#</a> 6.3 L2 -&gt; L3（数据链路层 -&gt; 网络层）</h2> <h3 id="step-6-通用-xdp-处理-gxdp"><a href="#step-6-通用-xdp-处理-gxdp" class="header-anchor">#</a> Step 6：通用 XDP 处理（gXDP）</h3> <p><img src="/assets/img/dp-highlight-gxdp.6dd8b89f.png" alt="img"></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>receive_skb()` 之后，我们又来到了另一个 XDP 程序执行点。这里可以通过 `receive_xdp()` **做一些通用（generic）的事情**，因此我在图中将其标注为 `(g)XDP
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>Step 2 中提到，如果网卡驱动不支持 XDP，那 XDP 程序将延迟到更后面执行，这个 <strong>“更后面”的位置指的就是这里的 <code>(g)XDP</code></strong>。</p> <h3 id="step-7-tap-设备处理"><a href="#step-7-tap-设备处理" class="header-anchor">#</a> Step 7：Tap 设备处理</h3> <p><img src="/assets/img/dp-highlight-tap.40134a6e.png" alt="img"></p> <p>图中有个 <code>*check_taps</code> 框，但其实并没有这个方法：<code>receive_skb()</code> 会轮询所有的 socket tap，将包放到正确的 tap 设备的缓冲区。</p> <p><strong>tap 设备监听的是三层协议</strong>（L3 protocols），例如 IPv4、ARP、IPv6 等等。 如果 tap 设备存在，它就可以操作这个 skb 了。</p> <h3 id="step-8-tc-traffic-classifier-处理"><a href="#step-8-tc-traffic-classifier-处理" class="header-anchor">#</a> Step 8：<code>tc</code>（traffic classifier）处理</h3> <p>接下来我们遇到了第二种 eBPF 程序：tc eBPF。</p> <p><img src="/assets/img/dp-highlight-tc.4ee35328.png" alt="img"></p> <p>tc（traffic classifier，流量分类器）是 Cilium 依赖的最基础的东西，它提供了多种功 能，例如修改包（mangle，给 skb 打标记）、重路由（reroute）、丢弃包（drop），<strong>这 些操作都会影响到内核的流量统计，因此也影响着包的排队规则</strong>（queueing discipline ）。</p> <p>Cilium 控制的网络设备，至少被加载了一个 tc eBPF 程序。</p> <blockquote><p>译者注：如何查看已加载的 eBPF 程序，可参考 <a href="http://arthurchiao.art/blog/cilium-network-topology-on-aws/" target="_blank" rel="noopener noreferrer">Cilium Network Topology and Traffic Path on AWS<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p></blockquote> <h3 id="step-9-netfilter-处理"><a href="#step-9-netfilter-处理" class="header-anchor">#</a> Step 9：Netfilter 处理</h3> <p>如果 tc BPF 返回 OK，包会再次进入 Netfilter。</p> <p><img src="/assets/img/dp-highlight-netfilter.6454d34a.png" alt="img"></p> <p>Netfilter 也会对入向的包进行处理，这里包括 <code>nftables</code> 和 <code>iptables</code> 模块。</p> <p>有一点需要记住的是：<strong>Netfilter 是网络栈的下半部分</strong>（the “bottom half” of the network stack），因此 iptables 规则越多，给网络栈下半部分造成的瓶颈就越大。</p> <p><code>*def_dev_protocol</code> 框是二层过滤器（L2 net filter），由于 Cilium 没有用到任何 L2 filter，因此这里我就不展开了。</p> <h3 id="step-10-l3-协议层处理-ip-rcv"><a href="#step-10-l3-协议层处理-ip-rcv" class="header-anchor">#</a> Step 10：L3 协议层处理：<code>ip_rcv()</code></h3> <p>最后，如果包没有被前面丢弃，就会通过网络设备的 <code>ip_rcv()</code> 方法进入协议栈的三层（ L3）—— 即 IP 层 —— 进行处理。</p> <p><img src="/assets/img/dp-highlight-ip-rcv.c355e2cb.png" alt="img"></p> <p>接下来我们将主要关注这个函数，但这里需要提醒大家的是，Linux 内核也支持除了 IP 之 外的其他三层协议，它们的 datapath 会与此有些不同。</p> <h2 id="_6-4-l3-l4-网络层-传输层"><a href="#_6-4-l3-l4-网络层-传输层" class="header-anchor">#</a> 6.4 L3 -&gt; L4（网络层 -&gt; 传输层）</h2> <h3 id="step-11-netfilter-l4-处理"><a href="#step-11-netfilter-l4-处理" class="header-anchor">#</a> Step 11：Netfilter L4 处理</h3> <p><img src="/assets/img/dp-highlight-netfilter-l4.1508811c.png" alt="img"></p> <p><code>ip_rcv()</code> 做的第一件事情是再次执行 Netfilter 过滤，因为我们现在是从四层（L4）的 视角来处理 socker buffer。因此，这里会执行 Netfilter 中的任何四层规则（L4 rules ）。</p> <h3 id="step-12-ip-rcv-finish-处理"><a href="#step-12-ip-rcv-finish-处理" class="header-anchor">#</a> Step 12：<code>ip_rcv_finish()</code> 处理</h3> <p>Netfilter 执行完成后，调用回调函数 <code>ip_rcv_finish()</code>。</p> <p><img src="/assets/img/dp-highlight-ip-rcv-finish.459576d4.png" alt="img"></p> <p><code>ip_rcv_finish()</code> 立即调用 <code>ip_routing()</code> 对包进行路由判断。</p> <h3 id="step-13-ip-routing-处理"><a href="#step-13-ip-routing-处理" class="header-anchor">#</a> Step 13：<code>ip_routing()</code> 处理</h3> <p><code>ip_routing()</code> 对包进行路由判断，例如看它是否是在 lookback 设备上，是否能 路由出去（could egress），或者能否被路由，能否被 unmangle 到其他设备等等。</p> <p><img src="/assets/img/dp-highlight-ip-routing.2c198971.png" alt="img"></p> <p>在 Cilium 中，如果没有使用隧道模式（tunneling），那就会用到这里的路由功能。相比 隧道模式，路由模式会的 datapath 路径更短，因此性能更高。</p> <h3 id="step-14-目的是本机-ip-local-deliver-处理"><a href="#step-14-目的是本机-ip-local-deliver-处理" class="header-anchor">#</a> Step 14：目的是本机：<code>ip_local_deliver()</code> 处理</h3> <p>根据路由判断的结果，<strong>如果包的目的端是本机</strong>，会调用 <code>ip_local_deliver()</code> 方法。</p> <p><img src="/assets/img/dp-highlight-ip-local-deliver.56e6c795.png" alt="img"></p> <p><code>ip_local_deliver()</code> 会调用 <code>xfrm4_policy()</code>。</p> <h3 id="step-15-xfrm4-policy-处理"><a href="#step-15-xfrm4-policy-处理" class="header-anchor">#</a> Step 15：<code>xfrm4_policy()</code> 处理</h3> <p><code>xfrm4_policy()</code> 完成对包的<strong>封装、解封装、加解密</strong>等工作。例如，IPSec 就是在这里完成的。</p> <p><img src="/assets/img/dp-highlight-xfrm4-policy.85ea450a.png" alt="img"></p> <p>最后，根据四层协议的不同，<code>ip_local_deliver()</code> 会将最终的包送到 TCP 或 UDP 协议 栈。这里必须是这两种协议之一，否则设备会给源 IP 地址回一个 <code>ICMP destination unreachable</code> 消息。</p> <p>接下来我将拿 UDP 协议作为例子，因为 TCP 状态机太复杂了，不适合这里用于理解 datapath 和数据流。但不是说 TCP 不重要，Linux TCP 状态机还是非常值得好好学习的。</p> <h2 id="_6-5-l4-传输层-以-udp-为例"><a href="#_6-5-l4-传输层-以-udp-为例" class="header-anchor">#</a> 6.5 L4（传输层，以 UDP 为例）</h2> <h3 id="step-16-udp-rcv-处理"><a href="#step-16-udp-rcv-处理" class="header-anchor">#</a> Step 16：<code>udp_rcv()</code> 处理</h3> <p><img src="data:image/png;base64,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" alt="img"></p> <p><code>udp_rcv()</code> 对包的合法性进行验证，检查 UDP 校验和。然后，再次将包送到 <code>xfrm4_policy()</code> 进行处理。</p> <h3 id="step-17-xfrm4-policy-再次处理"><a href="#step-17-xfrm4-policy-再次处理" class="header-anchor">#</a> Step 17：<code>xfrm4_policy()</code> 再次处理</h3> <p><img src="data:image/png;base64,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" alt="img"></p> <p>这里再次对包执行 transform policies 是因为，某些规则能指定具体的四层协议，所以只 有到了协议层之后才能执行这些策略。</p> <h3 id="step-18-将包放入-socket-receive-queue"><a href="#step-18-将包放入-socket-receive-queue" class="header-anchor">#</a> Step 18：将包放入 <code>socket_receive_queue</code></h3> <p>这一步会拿端口（port）查找相应的 socket，然后将 skb 放到一个名为 <code>socket_receive_queue</code> 的链表。</p> <p><img src="data:image/png;base64,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" alt="img"></p> <h3 id="step-19-通知-socket-收数据-sk-data-ready"><a href="#step-19-通知-socket-收数据-sk-data-ready" class="header-anchor">#</a> Step 19：通知 socket 收数据：<code>sk_data_ready()</code></h3> <p>最后，<code>udp_rcv()</code> 调用 <code>sk_data_ready()</code> 方法，标记这个 socket 有数据待收。</p> <p><img src="data:image/png;base64,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" alt="img"></p> <p>本质上，一个 socket 就是 Linux 中的一个文件描述符，这个描述符有一组相关的文件操 作抽象，例如 <code>read</code>、<code>write</code> 等等。</p> <h3 id="网络栈下半部分小结"><a href="#网络栈下半部分小结" class="header-anchor">#</a> 网络栈下半部分小结</h3> <p>以上 <strong>Step 1~19 就是 Linux 网络栈下半部分（bottom half of the network stack）的全部内容</strong>。</p> <p>接下来我们还会介绍几个内核函数，但它们都是与进程上下文相关的。</p> <h2 id="_6-6-l4-user-space"><a href="#_6-6-l4-user-space" class="header-anchor">#</a> 6.6 L4 - User Space</h2> <p>下图左边是一段 socket listening 程序，这里省略了错误检查，而且 <code>epoll</code> 本质上也 是不需要的，因为 UDP 的 recv 方法以及在帮我们 poll 了。</p> <p><img src="/assets/img/userspace-sample.a89090ca.png" alt="img"></p> <p>由于大家还是对 TCP 熟悉一些，因此在这里我假设这是一段 TCP 代码。<strong>事实上当我们调 用 <code>recvmsg()</code> 方法时，内核所做的事情就和上面这段代码差不多</strong>。对照右边的图：</p> <ol><li>首先初始化一个 epoll 实例和一个 UDP socket，然后告诉 epoll 实例我们想 监听这个 socket 上的 receive 事件，然后等着事件到来。</li> <li>当 socket buffer 收到数据时，其 wait queue 会被上一节的 <code>sk_data_ready()</code> 方法置位（标记）。</li> <li>epoll 监听在 wait queue，因此 epoll 收到事件通知后，提取事件内容，返回给用户空间。</li> <li>用户空间程序调用 <code>recv</code> 方法，它接着调用 <code>udp_recv_msg</code> 方法，后者又会 调用 <strong>cgroup eBPF 程序</strong> —— 这是本文出现的第三种 BPF 程序。<strong>Cilium 利用 cgroup eBPF 实现 socket level 负载均衡</strong>，这非常酷：
<ul><li>一般的客户端负载均衡对客户端并不是透明的，即，客户端应用必须将负载均衡逻辑内置到应用里。</li> <li>有了 cgroup BPF，客户端根本感知不到负载均衡的存在。</li></ul></li> <li>本文介绍的最后一种 BPF 程序是 <strong>sock_ops BPF，用于 socket level 整流</strong>（traffic shaping ），这对某些功能至关重要，例如客户端级别的限速（rate limiting）。</li> <li>最后，我们有一个用户空间缓冲区，存放收到的数据。</li></ol> <p>以上就是 <strong>Cilium 基于 eBPF 的内核收包之旅</strong>（traversing the kernel’s datapath）。太壮观了！</p> <h1 id="_7-kubernets、cilium-和-kernel-原子对象对应关系"><a href="#_7-kubernets、cilium-和-kernel-原子对象对应关系" class="header-anchor">#</a> 7 Kubernets、Cilium 和 Kernel：原子对象对应关系</h1> <table><thead><tr><th style="text-align:left;">Kubernetes</th> <th style="text-align:left;">Cilium</th> <th style="text-align:left;">Kernel</th></tr></thead> <tbody><tr><td style="text-align:left;">Endpoint (includes Pods)</td> <td style="text-align:left;">Endpoint</td> <td style="text-align:left;">tc, cgroup socket BPF, sock_ops BPF, XDP</td></tr> <tr><td style="text-align:left;">Network Policy</td> <td style="text-align:left;">Cilium Network Policy</td> <td style="text-align:left;">XDP, tc, sock-ops</td></tr> <tr><td style="text-align:left;">Service (node ports, cluster ips, etc)</td> <td style="text-align:left;">Service</td> <td style="text-align:left;">XDP, tc</td></tr> <tr><td style="text-align:left;">Node</td> <td style="text-align:left;">Node</td> <td style="text-align:left;">ip-xfrm (for encryption), ip tables for initial decapsulation routing (if vxlan), veth-pair, ipvlan</td></tr></tbody></table> <p>以上就是 Kubernetes 的所有网络对象（the only artificial network objects）。什么意思？ 这就是 k8s CNI 所依赖的全部网络原语（network primitives）。例如，LoadBalancer 对象只是 ClusterIP 和 NodePort 的组合，而后二者都属于 Service 对象，所以他们并不 是一等对象。</p> <p>这张图非常有价值，但不幸的是，实际情况要比这里列出的更加复杂，因为 Cilium 本身的 实现是很复杂的。这有两个主要原因，我觉得值得拿出来讨论和体会：</p> <p>首先，内核 datapath 要远比我这里讲的复杂。</p> <ol><li>前面只是非常简单地介绍了协议栈每个位置（Netfilter、iptables、eBPF、XDP）能执行的动作。</li> <li>这些位置提供的处理能力是不同的。例如
<ol><li>XDP 可能是能力最受限的，因为它只是设计用来做<strong>快速丢包</strong>（fast dropping）和 <strong>非本地重定向</strong>（non-local redirecting）；但另一方面，它又是最快的程序，因为 它在整个 datapath 的最前面，具备对整个 datapath 进行短路处理（short circuit the entire datapath）的能力。</li> <li>tc 和 iptables 程序能方便地 mangle 数据包，而不会对原来的转发流程产生显著影响。</li></ol></li></ol> <p>理解这些东西非常重要，因为<strong>这是 Cilium 乃至广义 datapath 里非常核心的东西</strong>。如 果遇到底层网络问题，或者需要做 Cilium/kernel 调优，那你必须要理解包的收发/转发 路径，有时你会发现包的某些路径非常反直觉。</p> <p>第二个原因是，eBPF 还非常新，某些最新特性只有在 5.x 内核中才有。尤其是 XDP BPF， 可能一个节点的内核版本支持，调度到另一台节点时，可能就不支持。</p></div></section> <footer class="page-edit"><!----> <!----></footer> <!----> <div class="comments-wrapper"><!----></div> <ul class="side-bar sub-sidebar-wrapper" style="width:12rem;" data-v-cb1513f6><li class="level-3" data-v-cb1513f6><a href="/docs/ebpf/epbf-cilium.html#译者序" class="sidebar-link reco-side-译者序" data-v-cb1513f6>译者序</a></li><li class="level-2" data-v-cb1513f6><a href="/docs/ebpf/epbf-cilium.html#_1-1-网络成为瓶颈" class="sidebar-link reco-side-_1-1-网络成为瓶颈" data-v-cb1513f6>1.1 网络成为瓶颈</a></li><li class="level-2" data-v-cb1513f6><a href="/docs/ebpf/epbf-cilium.html#_1-2-ebpf-无处不在" class="sidebar-link reco-side-_1-2-ebpf-无处不在" data-v-cb1513f6>1.2 eBPF 无处不在</a></li><li class="level-2" data-v-cb1513f6><a href="/docs/ebpf/epbf-cilium.html#_1-3-性能就是金钱" class="sidebar-link reco-side-_1-3-性能就是金钱" data-v-cb1513f6>1.3 性能就是金钱</a></li><li class="level-2" data-v-cb1513f6><a href="/docs/ebpf/epbf-cilium.html#_3-1-快速" class="sidebar-link reco-side-_3-1-快速" data-v-cb1513f6>3.1 快速</a></li><li class="level-2" data-v-cb1513f6><a href="/docs/ebpf/epbf-cilium.html#_3-2-灵活" class="sidebar-link reco-side-_3-2-灵活" data-v-cb1513f6>3.2 灵活</a></li><li class="level-2" data-v-cb1513f6><a href="/docs/ebpf/epbf-cilium.html#_3-3-数据与功能分离" class="sidebar-link reco-side-_3-3-数据与功能分离" data-v-cb1513f6>3.3 数据与功能分离</a></li><li class="level-2" data-v-cb1513f6><a href="/docs/ebpf/epbf-cilium.html#_6-1-l1-l2-物理层-数据链路层" class="sidebar-link reco-side-_6-1-l1-l2-物理层-数据链路层" data-v-cb1513f6>6.1 L1 -&gt; L2（物理层 -&gt; 数据链路层）</a></li><li class="level-2" data-v-cb1513f6><a href="/docs/ebpf/epbf-cilium.html#_6-2-l2-续-数据链路层-续" class="sidebar-link reco-side-_6-2-l2-续-数据链路层-续" data-v-cb1513f6>6.2 L2 续（数据链路层 - 续）</a></li><li class="level-3" data-v-cb1513f6><a href="/docs/ebpf/epbf-cilium.html#step-1-napi-poll" class="sidebar-link reco-side-step-1-napi-poll" data-v-cb1513f6>Step 1：NAPI poll</a></li><li class="level-3" data-v-cb1513f6><a href="/docs/ebpf/epbf-cilium.html#step-2-xdp-程序处理" class="sidebar-link reco-side-step-2-xdp-程序处理" data-v-cb1513f6>Step 2：XDP 程序处理</a></li><li class="level-3" data-v-cb1513f6><a href="/docs/ebpf/epbf-cilium.html#step-3-clean-rx-创建-skb" class="sidebar-link reco-side-step-3-clean-rx-创建-skb" data-v-cb1513f6>Step 3：clean_rx()：创建 skb</a></li><li class="level-3" data-v-cb1513f6><a href="/docs/ebpf/epbf-cilium.html#step-4-gro-receive" class="sidebar-link reco-side-step-4-gro-receive" data-v-cb1513f6>Step 4：gro_receive()</a></li><li class="level-3" data-v-cb1513f6><a href="/docs/ebpf/epbf-cilium.html#step-5-receive-skb" class="sidebar-link reco-side-step-5-receive-skb" data-v-cb1513f6>Step 5：receive_skb()</a></li><li class="level-2" data-v-cb1513f6><a href="/docs/ebpf/epbf-cilium.html#_6-3-l2-l3-数据链路层-网络层" class="sidebar-link reco-side-_6-3-l2-l3-数据链路层-网络层" data-v-cb1513f6>6.3 L2 -&gt; L3（数据链路层 -&gt; 网络层）</a></li><li class="level-3" data-v-cb1513f6><a href="/docs/ebpf/epbf-cilium.html#step-6-通用-xdp-处理-gxdp" class="sidebar-link reco-side-step-6-通用-xdp-处理-gxdp" data-v-cb1513f6>Step 6：通用 XDP 处理（gXDP）</a></li><li class="level-3" data-v-cb1513f6><a href="/docs/ebpf/epbf-cilium.html#step-7-tap-设备处理" class="sidebar-link reco-side-step-7-tap-设备处理" data-v-cb1513f6>Step 7：Tap 设备处理</a></li><li class="level-3" data-v-cb1513f6><a href="/docs/ebpf/epbf-cilium.html#step-8-tc-traffic-classifier-处理" class="sidebar-link reco-side-step-8-tc-traffic-classifier-处理" data-v-cb1513f6>Step 8：tc（traffic classifier）处理</a></li><li class="level-3" data-v-cb1513f6><a href="/docs/ebpf/epbf-cilium.html#step-9-netfilter-处理" class="sidebar-link reco-side-step-9-netfilter-处理" data-v-cb1513f6>Step 9：Netfilter 处理</a></li><li class="level-3" data-v-cb1513f6><a href="/docs/ebpf/epbf-cilium.html#step-10-l3-协议层处理-ip-rcv" class="sidebar-link reco-side-step-10-l3-协议层处理-ip-rcv" data-v-cb1513f6>Step 10：L3 协议层处理：ip_rcv()</a></li><li class="level-2" data-v-cb1513f6><a href="/docs/ebpf/epbf-cilium.html#_6-4-l3-l4-网络层-传输层" class="sidebar-link reco-side-_6-4-l3-l4-网络层-传输层" data-v-cb1513f6>6.4 L3 -&gt; L4（网络层 -&gt; 传输层）</a></li><li class="level-3" data-v-cb1513f6><a href="/docs/ebpf/epbf-cilium.html#step-11-netfilter-l4-处理" class="sidebar-link reco-side-step-11-netfilter-l4-处理" data-v-cb1513f6>Step 11：Netfilter L4 处理</a></li><li class="level-3" data-v-cb1513f6><a href="/docs/ebpf/epbf-cilium.html#step-12-ip-rcv-finish-处理" class="sidebar-link reco-side-step-12-ip-rcv-finish-处理" data-v-cb1513f6>Step 12：ip_rcv_finish() 处理</a></li><li class="level-3" data-v-cb1513f6><a href="/docs/ebpf/epbf-cilium.html#step-13-ip-routing-处理" class="sidebar-link reco-side-step-13-ip-routing-处理" data-v-cb1513f6>Step 13：ip_routing() 处理</a></li><li class="level-3" data-v-cb1513f6><a href="/docs/ebpf/epbf-cilium.html#step-14-目的是本机-ip-local-deliver-处理" class="sidebar-link reco-side-step-14-目的是本机-ip-local-deliver-处理" data-v-cb1513f6>Step 14：目的是本机：ip_local_deliver() 处理</a></li><li class="level-3" data-v-cb1513f6><a href="/docs/ebpf/epbf-cilium.html#step-15-xfrm4-policy-处理" class="sidebar-link reco-side-step-15-xfrm4-policy-处理" data-v-cb1513f6>Step 15：xfrm4_policy() 处理</a></li><li class="level-2" data-v-cb1513f6><a href="/docs/ebpf/epbf-cilium.html#_6-5-l4-传输层-以-udp-为例" class="sidebar-link reco-side-_6-5-l4-传输层-以-udp-为例" data-v-cb1513f6>6.5 L4（传输层，以 UDP 为例）</a></li><li class="level-3" data-v-cb1513f6><a href="/docs/ebpf/epbf-cilium.html#step-16-udp-rcv-处理" class="sidebar-link reco-side-step-16-udp-rcv-处理" data-v-cb1513f6>Step 16：udp_rcv() 处理</a></li><li class="level-3" data-v-cb1513f6><a href="/docs/ebpf/epbf-cilium.html#step-17-xfrm4-policy-再次处理" class="sidebar-link reco-side-step-17-xfrm4-policy-再次处理" data-v-cb1513f6>Step 17：xfrm4_policy() 再次处理</a></li><li class="level-3" data-v-cb1513f6><a href="/docs/ebpf/epbf-cilium.html#step-18-将包放入-socket-receive-queue" class="sidebar-link reco-side-step-18-将包放入-socket-receive-queue" data-v-cb1513f6>Step 18：将包放入 socket_receive_queue</a></li><li class="level-3" data-v-cb1513f6><a href="/docs/ebpf/epbf-cilium.html#step-19-通知-socket-收数据-sk-data-ready" class="sidebar-link reco-side-step-19-通知-socket-收数据-sk-data-ready" data-v-cb1513f6>Step 19：通知 socket 收数据：sk_data_ready()</a></li><li class="level-3" data-v-cb1513f6><a href="/docs/ebpf/epbf-cilium.html#网络栈下半部分小结" class="sidebar-link reco-side-网络栈下半部分小结" data-v-cb1513f6>网络栈下半部分小结</a></li><li class="level-2" data-v-cb1513f6><a href="/docs/ebpf/epbf-cilium.html#_6-6-l4-user-space" class="sidebar-link reco-side-_6-6-l4-user-space" data-v-cb1513f6>6.6 L4 - User Space</a></li></ul></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div><!----><div class="reco-bgm-panel" data-v-b1d3339e><audio id="bgm" src="https://music.163.com/song/media/outer/url?id=1846489646.mp3" data-v-b1d3339e></audio> <div class="reco-float-box" style="bottom:200px;z-index:999999;display:none;" data-v-b1d3339e data-v-41bcba48 data-v-b1d3339e><img src="https://p1.music.126.net/LoVqPgkI7DwSNZk50gcODg==/109951165994863998.jpg?param=130y130" data-v-b1d3339e></div> <div class="reco-bgm-box" style="left:10px;bottom:10px;z-index:999999;" data-v-b1d3339e data-v-41bcba48 data-v-b1d3339e><div class="reco-bgm-cover" style="background-image:url(https://p1.music.126.net/LoVqPgkI7DwSNZk50gcODg==/109951165994863998.jpg?param=130y130);" data-v-b1d3339e><div class="mini-operation" style="display:none;" data-v-b1d3339e><i class="reco-bgm reco-bgm-pause" style="display:none;" data-v-b1d3339e></i> <i class="reco-bgm reco-bgm-play" style="display:none;" data-v-b1d3339e></i></div> <div class="falut-message" style="display:none;" data-v-b1d3339e>
          播放失败
        </div></div> <div class="reco-bgm-info" data-v-b1d3339e data-v-41bcba48 data-v-b1d3339e><div class="info-box" data-v-b1d3339e><i class="reco-bgm reco-bgm-music music" data-v-b1d3339e></i>嘉宾</div> <div class="info-box" data-v-b1d3339e><i class="reco-bgm reco-bgm-artist" data-v-b1d3339e></i>路文飞</div> <div class="reco-bgm-progress" data-v-b1d3339e><div class="progress-bar" data-v-b1d3339e><div class="bar" data-v-b1d3339e></div></div></div> <div class="reco-bgm-operation" data-v-b1d3339e><i class="reco-bgm reco-bgm-last last" data-v-b1d3339e></i> <i class="reco-bgm reco-bgm-pause pause" style="display:none;" data-v-b1d3339e></i> <i class="reco-bgm reco-bgm-play play" data-v-b1d3339e></i> <i class="reco-bgm reco-bgm-next next" data-v-b1d3339e></i> <i class="reco-bgm reco-bgm-volume1 volume" data-v-b1d3339e></i> <i class="reco-bgm reco-bgm-mute mute" style="display:none;" data-v-b1d3339e></i> <div class="volume-bar" data-v-b1d3339e><div class="bar" data-v-b1d3339e></div></div></div></div> <div class="reco-bgm-left-box" data-v-b1d3339e data-v-41bcba48 data-v-b1d3339e><i class="reco-bgm reco-bgm-left" data-v-b1d3339e></i></div></div></div></div></div>
    <script src="/assets/js/app.c3a3c59f.js" defer></script><script src="/assets/js/3.fffc709b.js" defer></script><script src="/assets/js/1.b1aed609.js" defer></script><script src="/assets/js/4.b8b133d8.js" defer></script>
  </body>
</html>
