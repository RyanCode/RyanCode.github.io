(window.webpackJsonp=window.webpackJsonp||[]).push([[8],{588:function(t,s,a){t.exports=a.p+"assets/img/tpkt_header.ab141bf2.png"},589:function(t,s,a){t.exports=a.p+"assets/img/x224_01.5a4a75bb.png"},590:function(t,s,a){t.exports=a.p+"assets/img/fp_header.4285831e.png"},591:function(t,s,a){t.exports=a.p+"assets/img/mcs_gcc_req.da773a85.png"},592:function(t,s,a){t.exports=a.p+"assets/img/mcs_gcc_res.3af98e52.png"},593:function(t,s,a){t.exports=a.p+"assets/img/mcsCi01.24dbb20f.png"},594:function(t,s,a){t.exports=a.p+"assets/img/TS_UD_CS_MULTITRANSPORT.66ad8439.png"},619:function(t,s,a){"use strict";a.r(s);var n=a(6),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("p"),n("div",{staticClass:"table-of-contents"},[n("ul",[n("li",[n("a",{attrs:{href:"#概述"}},[t._v("概述")])]),n("li",[n("a",{attrs:{href:"#tpkt"}},[t._v("TPKT")])]),n("li",[n("a",{attrs:{href:"#x224"}},[t._v("x224")])]),n("li",[n("a",{attrs:{href:"#client-side-fast-path"}},[t._v("Client Side Fast Path")])]),n("li",[n("a",{attrs:{href:"#mcs-in-rdp"}},[t._v("MCS IN RDP")])]),n("li",[n("a",{attrs:{href:"#ts-ud-cs-multitransport"}},[t._v("TSUDCS_MULTITRANSPORT")])])])]),n("p"),t._v(" "),n("div",{staticClass:"custom-block warning"},[n("p",{staticClass:"title"}),n("p",[t._v("这篇博客主要解析 [MS-RDPBCGR]相关协议和内容，建议先去看wpo篇。尚未完结，持续更新(本博客代码片段以客户端视角进行解析)")])]),n("h3",{attrs:{id:"概述"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#概述"}},[t._v("#")]),t._v(" 概述")]),t._v(" "),n("p",[t._v("在概述中首先明确了和其他协议的关系，以下提取一些开发中常用的协议:")]),t._v(" "),n("p",[t._v("x224,还有一些协议在 [MS-RDPBCGR] 静态虚拟通道内通过隧道传输，这部分是一些虚拟通道的拓展，熟知的有粘贴板通道、文件传输通道、智能卡通道、音频输出通道等。")]),t._v(" "),n("p",[t._v("目前我本身比较关注的是GDI和RFX编解码器拓展。这两个对与优化视频传输很重要。还包括对UDP的协商，这个好像很有意思还没深入看。")]),t._v(" "),n("p",[t._v("rdp的在协商Capability之前还会有一些操作，其中重要的是对错误信息PDU的支持，这个是必要的，因为服务器必须知道如何将错误传回给客户端。功能集中交换的信息包括支持的"),n("a",{attrs:{href:"https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-rdpbcgr/ab35aee7-1cf7-42dc-ac74-d0d7f4ca64f7#gt_34715e6f-1612-4b2d-a4bb-3305c56e96f5",target:"_blank",rel:"noopener noreferrer"}},[t._v("PDU"),n("OutboundLink")],1),t._v("和绘图顺序、桌面尺寸和允许的颜色深度、输入设备支持、缓存结构和功能支持等数据。")]),t._v(" "),n("p",[n("strong",[t._v("除非另有说明，消息中的所有多字节字段必须以 little-endian 字节顺序编组。")])]),t._v(" "),n("h3",{attrs:{id:"tpkt"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#tpkt"}},[t._v("#")]),t._v(" TPKT")]),t._v(" "),n("p",[t._v("**TPKT 被正式定义为“TCP 之上的 ISO 传输服务”。“TCP”和“ISO”与两个相互竞争的网络协议套件有关。TPKT 支持在这两个组之间进行翻译。PDU使用tpkt协议封装，[MS-RDPBCGR] 数据包封装在"),n("a",{attrs:{href:"https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-rdpbcgr/ab35aee7-1cf7-42dc-ac74-d0d7f4ca64f7#gt_b08d36f6-b5c6-4ce4-8d2d-6f2ab75ea4cb",target:"_blank",rel:"noopener noreferrer"}},[t._v("传输控制协议 (TCP)"),n("OutboundLink")],1),t._v("中。TCP 数据包必须封装在 IP 协议的版本 4 或 6 中。**与大多数网络协议一样，TPKT 也可以反向工作。当一个 TPKT 数据包到达时，TPKT 剥离其数据包结构并将携带的数据包向上传递到协议栈。接收数据的 OSI 协议不知道 TCP/IP 参与了数据传输。")]),t._v(" "),n("p",[t._v("在解析之前需要先说一下tpkt header，这是tpkt协议的关键，因为这里就是header+payload")]),t._v(" "),n("h4",{attrs:{id:"tpkt-header-t123-section-8"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#tpkt-header-t123-section-8"}},[t._v("#")]),t._v(" Tpkt header:(t123 section 8)")]),t._v(" "),n("p",[n("img",{attrs:{src:a(588),alt:"x224_01"}})]),t._v(" "),n("h3",{attrs:{id:"x224"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#x224"}},[t._v("#")]),t._v(" x224")]),t._v(" "),n("p",[t._v("The length of the CR-TPDU shall not exceed 128 octets.")]),t._v(" "),n("p",[n("img",{attrs:{src:a(589),alt:"x224_01"}})]),t._v(" "),n("p",[t._v("我们就拿x224的CR举例说明吧，这个是在RDP协商中 X.224 0 类连接请求传输协议数据单元 (TPDU)。0类和1类x224CDT都会设置成0")]),t._v(" "),n("p",[t._v("整个octet2转10进制int就是224。在"),n("strong",[t._v("客户端发送x224 pdu")]),t._v("时，通常讲将协商请求一同发送，具体可以参考"),n("a",{attrs:{href:"https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-rdpbcgr/902b090b-9cb3-4efc-92bf-ee13373371e3",target:"_blank",rel:"noopener noreferrer"}},[t._v("RDP_NEG_REQ"),n("OutboundLink")],1),t._v("。在解析x224crq包时，通常不会单独的解析CR和CDT，直接读入uint8，如果是224，那么说明解析正确，LI是当作length字段的标识使用的。这里没有使用价值。这个包占用7个字节，读到code(CRCDT)后，还剩下五个字节。client端通常会写入全0，server端处理可以直接丢弃。DST-REF (2 bytes)SRC-REF (2 bytes) [CR, CC] CLASS OPTION (1 byte) or [DR] REASON (1 byte)。具体可以参考上图。接下来的解析就有三种情况了:")]),t._v(" "),n("ol",[n("li",[t._v("Cookie")]),t._v(" "),n("li",[t._v("RDP Negotiation Request")]),t._v(" "),n("li",[t._v("rdpCorrelationInfo")])]),t._v(" "),n("p",[t._v("具体这里不再累述，可以参考"),n("a",{attrs:{href:"https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-rdpbcgr/18a27ef9-6f9a-4501-b000-94b1fe3c2c10",target:"_blank",rel:"noopener noreferrer"}},[t._v("Client X.224 Connection Request PDU"),n("OutboundLink")],1)]),t._v(" "),n("h4",{attrs:{id:"client-side-example"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#client-side-example"}},[t._v("#")]),t._v(" Client Side Example")]),t._v(" "),n("div",{staticClass:"language-rust line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-rust"}},[n("code",[t._v("        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("mut")]),t._v(" buffer "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Cursor")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("::")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("new")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("self")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("transport"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("read")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("mut")]),t._v(" action"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("u8")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        action"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("read")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("mut")]),t._v(" buffer"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" action "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Action")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("::")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("FastPathActionX224")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("u8")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// read padding")]),t._v("\n            "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("mut")]),t._v(" padding"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("u8")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            padding"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("read")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("mut")]),t._v(" buffer"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// now wait extended header")]),t._v("\n            buffer "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Cursor")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("::")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("new")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("self")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("transport"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("read")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n            "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("mut")]),t._v(" size "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("U16")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("::")]),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("BE")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            size"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("read")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("mut")]),t._v(" buffer"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n            "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Minimal size must be 7")]),t._v("\n            "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" size"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("inner")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Err")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Error")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("::")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("RdpError")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("RdpError")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("::")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("new")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n                    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("RdpErrorKind")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("::")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("InvalidSize")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                    "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Invalid minimal size for TPKT"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// now wait for body")]),t._v("\n                "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Ok")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Payload")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("::")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Raw")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Cursor")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("::")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("new")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n                    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("self")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("transport"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("read")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("size"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("inner")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("usize")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br"),n("span",{staticClass:"line-number"},[t._v("16")]),n("br"),n("span",{staticClass:"line-number"},[t._v("17")]),n("br"),n("span",{staticClass:"line-number"},[t._v("18")]),n("br"),n("span",{staticClass:"line-number"},[t._v("19")]),n("br"),n("span",{staticClass:"line-number"},[t._v("20")]),n("br"),n("span",{staticClass:"line-number"},[t._v("21")]),n("br"),n("span",{staticClass:"line-number"},[t._v("22")]),n("br"),n("span",{staticClass:"line-number"},[t._v("23")]),n("br"),n("span",{staticClass:"line-number"},[t._v("24")]),n("br"),n("span",{staticClass:"line-number"},[t._v("25")]),n("br")])]),n("h4",{attrs:{id:"test-case"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#test-case"}},[t._v("#")]),t._v(" Test Case")]),t._v(" "),n("div",{staticClass:"language-rust line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-rust"}},[n("code",[t._v("     "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("mut")]),t._v(" tpkt "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("tpkt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("::")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Client")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("::")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("new")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("link"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("::")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Link")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("::")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("new")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("link"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("::")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Stream")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("::")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Raw")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Cursor")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("::")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("new")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token macro property"}},[t._v("vec!")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n     "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("tpkt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("::")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Payload")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("::")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Raw")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("c"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" tpkt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("read")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("unwrap")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n         "),n("span",{pre:!0,attrs:{class:"token macro property"}},[t._v("assert_eq!")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("c"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("into_inner")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token macro property"}},[t._v("vec!")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n     "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n     "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n         "),n("span",{pre:!0,attrs:{class:"token macro property"}},[t._v("panic!")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"unexpected result"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n     "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br")])]),n("p",[t._v("说到这里就不得不说rdp对tpkt的两层封装，第一种也就上面说明的，还有一种就是"),n("strong",[t._v("快速路径")])]),t._v(" "),n("h3",{attrs:{id:"client-side-fast-path"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#client-side-fast-path"}},[t._v("#")]),t._v(" Client Side Fast Path")]),t._v(" "),n("div",{staticClass:"custom-block warning"},[n("p",{staticClass:"title"}),n("p",[t._v("Fast-Path Input Event PDU 用于将输入事件从客户端传输到服务器。快速路径从第一个字节开始修改客户端输入数据包，目的是提高带宽。TPKT Header（["),n("a",{attrs:{href:"https://go.microsoft.com/fwlink/?LinkId=90541",target:"_blank",rel:"noopener noreferrer"}},[t._v("T123]"),n("OutboundLink")],1),t._v("第 8 节(上面介绍过来了)、X.224 Class 0 Data TPDU（["),n("a",{attrs:{href:"https://go.microsoft.com/fwlink/?LinkId=90588",target:"_blank",rel:"noopener noreferrer"}},[t._v("X224]"),n("OutboundLink")],1),t._v("第 13.7 节）和 MCS 发送数据请求（["),n("a",{attrs:{href:"https://go.microsoft.com/fwlink/?LinkId=90543",target:"_blank",rel:"noopener noreferrer"}},[t._v("T125]"),n("OutboundLink")],1),t._v("第 11.32 节）被替换；安全头（第"),n("a",{attrs:{href:"https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-rdpbcgr/9865e0ce-a540-4eab-9409-2a25937c38d2",target:"_blank",rel:"noopener noreferrer"}},[t._v("2.2.8.1.1.2 节）"),n("OutboundLink")],1),t._v("折叠到快速路径输入头中，"),n("a",{attrs:{href:"https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-rdpbcgr/4b5d4c0d-a657-41e9-9c69-d58632f46d31",target:"_blank",rel:"noopener noreferrer"}},[t._v("共享数据头（第 2.2.8.1.1.1.2 节）"),n("OutboundLink")],1),t._v("被新的快速路径格式替换。输入通知事件的内容（第"),n("a",{attrs:{href:"https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-rdpbcgr/a9a26b3d-84a2-495f-83fc-9edd6601f33b",target:"_blank",rel:"noopener noreferrer"}},[t._v("2.2.8.1.1.3.1.1"),n("OutboundLink")],1),t._v("节）也被更改以减小它们的大小，特别是通过删除或减少标题。对快速路径输入的支持在"),n("a",{attrs:{href:"https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-rdpbcgr/b3bc76ae-9ee5-454f-b197-ede845ca69cc",target:"_blank",rel:"noopener noreferrer"}},[t._v("输入能力集（第 2.2.7.1.6 节）"),n("OutboundLink")],1),t._v("。")])]),n("div",{staticClass:"language-html line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-html"}},[n("code",[t._v("| fpOutputHeader uint8 | length1 uint8 | length2 uint8(optional) |fipsInformation (4 bytes)(optional)|dataSignature (8 bytes)fpOutputHeader|fpOutputUpdates (variable)\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br")])]),n("h4",{attrs:{id:"fpoutputheader"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#fpoutputheader"}},[t._v("#")]),t._v(" "),n("strong",[t._v("fpOutputHeader")])]),t._v(" "),n("p",[t._v("在解析fastpath时，他的头只有一个单字节。这一个字节包含了两个信息")]),t._v(" "),n("p",[t._v("The format of the "),n("strong",[t._v("fpOutputHeader")]),t._v(" byte is described by the following bitmask diagram.")]),t._v(" "),n("p",[n("img",{attrs:{src:a(590),alt:"x224_01"}})]),t._v(" "),n("ul",[n("li",[t._v("Security flags")]),t._v(" "),n("li",[t._v("Action code")])]),t._v(" "),n("div",{staticClass:"language-rust line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-rust"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("pub")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("enum")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token type-definition class-name"}},[t._v("Action")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("FastPathActionFastPath")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0x0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("FastPathActionX224")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0x3")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br")])]),n("p",[t._v("如何解析Security flags呢？可以看到flags在最后两比特位置，简单，直接与高6位全0低2位全1，其实就是3,action、reserved同理。")]),t._v(" "),n("table",[n("thead",[n("tr",[n("th",{staticStyle:{"text-align":"left"}},[t._v("Flag (2 bits)")]),t._v(" "),n("th",{staticStyle:{"text-align":"left"}},[t._v("Meaning")])])]),t._v(" "),n("tbody",[n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("FASTPATH_OUTPUT_SECURE_CHECKSUM0x1")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("Indicates that the "),n("a",{attrs:{href:"https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-rdpbcgr/ab35aee7-1cf7-42dc-ac74-d0d7f4ca64f7#gt_3a669297-5242-417e-bff9-5828a186fcf8",target:"_blank",rel:"noopener noreferrer"}},[t._v("MAC"),n("OutboundLink")],1),t._v(' signature for the PDU was generated using the "salted MAC generation" technique (section '),n("a",{attrs:{href:"https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-rdpbcgr/f390586a-3fdd-4a96-bbe0-a31575e92056",target:"_blank",rel:"noopener noreferrer"}},[t._v("5.3.6.1.1"),n("OutboundLink")],1),t._v("). If this bit is not set, then the standard technique was used (sections "),n("a",{attrs:{href:"https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-rdpbcgr/768e12c4-7748-4005-b91d-790847e47025",target:"_blank",rel:"noopener noreferrer"}},[t._v("2.2.8.1.1.2.2"),n("OutboundLink")],1),t._v(" and "),n("a",{attrs:{href:"https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-rdpbcgr/463bd2eb-c3b1-4986-86b0-a240819d9088",target:"_blank",rel:"noopener noreferrer"}},[t._v("2.2.8.1.1.2.3"),n("OutboundLink")],1),t._v(").")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("FASTPATH_OUTPUT_ENCRYPTED0x2")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("Indicates that the PDU contains an 8-byte MAC signature after the optional "),n("strong",[t._v("length2")]),t._v(" field (that is, the "),n("strong",[t._v("dataSignature")]),t._v(" field is present), and the contents of the PDU are encrypted using the negotiated encryption package (sections "),n("a",{attrs:{href:"https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-rdpbcgr/b9a49d9e-44db-46aa-90a7-bb7f75718e02",target:"_blank",rel:"noopener noreferrer"}},[t._v("5.3.2"),n("OutboundLink")],1),t._v(" and "),n("a",{attrs:{href:"https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-rdpbcgr/249516af-0511-4566-9ef5-f499ddb77a51",target:"_blank",rel:"noopener noreferrer"}},[t._v("5.3.6"),n("OutboundLink")],1),t._v(").")])])])]),t._v(" "),n("p",[n("strong",[t._v("action (2 bits):")]),t._v(" A 2-bit, unsigned integer that indicates whether the PDU is in fast-path or slow-path format.")]),t._v(" "),n("table",[n("thead",[n("tr",[n("th",{staticStyle:{"text-align":"left"}},[t._v("Value (2 bits)")]),t._v(" "),n("th",{staticStyle:{"text-align":"left"}},[t._v("Meaning")])])]),t._v(" "),n("tbody",[n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("FASTPATH_OUTPUT_ACTION_FASTPATH0x0")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("Indicates that the "),n("a",{attrs:{href:"https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-rdpbcgr/ab35aee7-1cf7-42dc-ac74-d0d7f4ca64f7#gt_34715e6f-1612-4b2d-a4bb-3305c56e96f5",target:"_blank",rel:"noopener noreferrer"}},[t._v("PDU"),n("OutboundLink")],1),t._v(" is a fast-path output PDU.")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("FASTPATH_OUTPUT_ACTION_X2240x3")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("Indicates the presence of a TPKT Header ([T123] section 8) initial version byte which indicates that the PDU is a slow-path output PDU (in this case the full value of the initial byte MUST be 0x03).")])])])]),t._v(" "),n("h4",{attrs:{id:"length1-1-byte"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#length1-1-byte"}},[t._v("#")]),t._v(" "),n("strong",[t._v("length1 (1 byte):")])]),t._v(" "),n("blockquote",[n("p",[t._v("An 8-bit, unsigned integer. If the most significant bit of the "),n("strong",[t._v("length1")]),t._v(" field is not set, then the size of the PDU is in the range 1 to 127 bytes and the "),n("strong",[t._v("length1")]),t._v(" field contains the overall PDU length (the "),n("strong",[t._v("length2")]),t._v(" field is not present in this case). However, if the most significant bit of the "),n("strong",[t._v("length1")]),t._v(" field is set, then the overall PDU length is given by the low 7 bits of the "),n("strong",[t._v("length1")]),t._v(" field concatenated with the 8 bits of the "),n("strong",[t._v("length2")]),t._v(" field, in big-endian order (the "),n("strong",[t._v("length2")]),t._v(" field contains the low-order bits). The overall PDU length SHOULD be less than or equal to 16,383 bytes.")])]),t._v(" "),n("p",[t._v("意思是"),n("strong",[t._v("如果未设置length1")]),t._v("字段的最高有效位，则 PDU 的大小在 1 到 127 个字节的范围内，并且"),n("strong",[t._v("length1")]),t._v("字段包含整个 PDU 长度（在这种情况下不存在"),n("strong",[t._v("length2字段）。"),n("strong",[t._v("但是，如果设置了长度 1字段的最高有效位，则整个 PDU 长度由")]),t._v("length 1")]),t._v(" 字段的低 7 位与"),n("strong",[t._v("length 2")]),t._v(" 字段的 8 位以"),n("strong",[t._v("大端")]),t._v("顺序连接（"),n("strong",[t._v("长度 2")]),t._v("字段包含低位）。整个 PDU 长度应该小于或等于 16,383 字节。也就是十五位最高位1低位全为0。")]),t._v(" "),n("p",[t._v("最高有效位也就是二进制中从高位到低位第一个为1的位。因为是单字节，最高有效位为1得数最小就是0x80。这个数我们后面计算需要用到。")]),t._v(" "),n("h4",{attrs:{id:"如何计算length"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#如何计算length"}},[t._v("#")]),t._v(" 如何计算length？")]),t._v(" "),n("ol",[n("li",[n("p",[t._v("如果设置了最高有效位:")]),t._v(" "),n("div",{staticClass:"language-mathematica line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-mathematica"}},[n("code",[t._v("get length2 as uint16\n"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("//")]),t._v("对照上面的解释更好理解\nall "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("length1 "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v(" !"),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0x80")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" as uint16"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("length2 as uint16\nlength "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" all "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br")])])]),t._v(" "),n("li",[n("p",[t._v("如果没有设置最高有效位:")]),t._v(" "),n("div",{staticClass:"language-mathematica line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-mathematica"}},[n("code",[t._v("length "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" length1 as usize "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br")])])])]),t._v(" "),n("hr"),t._v(" "),n("p",[t._v("具体解析直接上代码（部分伪代码）")]),t._v(" "),n("div",{staticClass:"language-rust line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-rust"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// fast path")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("mut")]),t._v(" short_length"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("u8")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nshort_length"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("read")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("mut")]),t._v(" buffer"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" short_length "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0x80")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("mut")]),t._v(" hi_length"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("u8")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  hi_length"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("read")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("mut")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Cursor")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("::")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("new")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("self")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("transport"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("read")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" length"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("u16")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("short_length "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0x80")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("u16")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" length "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" length "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" hi_length "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("u16")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("read")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("length "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("usize")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("...")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("...")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//注意这里不同于上面的是没有读length2，所以需要减2")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("read")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("short_length "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("usize")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("...")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("...")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br")])]),n("blockquote",[n("p",[t._v("今天就写到这里吧......2022/10/6")])]),t._v(" "),n("p",[t._v("细心的同学在阅读快速路径的时候应该注意到了，他对tpkt、x224都有处理，这也正是我们上面着重介绍的，那么快速路径还对哪些协议或者相关封装也作了处理呢？上面已经说了,那就是msc、安全头、共享数据头、输入事件通知。那我们接下来就从这几个部分开始。")]),t._v(" "),n("div",{staticClass:"custom-block warning"},[n("p",{staticClass:"title"}),n("p",[t._v("到这里rdp协议的头部分封装协议大致就介绍完了，下面我们会对每个过程进行分析，其实在介绍x224和tpkt时已经内在介绍了协商的第一和第二步，下面一方面介绍mcs，一方面继续介绍协商。")])]),n("h3",{attrs:{id:"mcs-in-rdp"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#mcs-in-rdp"}},[t._v("#")]),t._v(" MCS IN RDP")]),t._v(" "),n("p",[t._v("先解释一下什么是mcs，文档中是这样描述的。")]),t._v(" "),n("div",{staticClass:"custom-block tip"},[n("p",{staticClass:"title"}),n("p",[n("strong",[t._v("Multipoint Communication Service (MCS)")]),t._v(": A data transmission protocol and set of services defined by the ITU T.120 standard, specifically ["),n("a",{attrs:{href:"https://go.microsoft.com/fwlink/?LinkId=94993",target:"_blank",rel:"noopener noreferrer"}},[t._v("T122]"),n("OutboundLink")],1),t._v(" and ["),n("a",{attrs:{href:"https://go.microsoft.com/fwlink/?LinkId=90543",target:"_blank",rel:"noopener noreferrer"}},[t._v("T125]"),n("OutboundLink")],1),t._v(".")])]),n("p",[t._v("简单的说就是个传输协议，其次是个多点传输协议。当然，包括一些服务集，具体就不深究了。**MCS Connect Initial PDU 封装了 GCC（Generic Conference Control） 会议创建请求，该请求封装了连接的设置数据块。**在协商阶段，通过使用 MCS Connect Initial PDU（第"),n("a",{attrs:{href:"https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-rdpbcgr/db6713ee-1c0e-4064-a3b3-0fac30b4037b",target:"_blank",rel:"noopener noreferrer"}},[t._v("2.2.1.3"),n("OutboundLink")],1),t._v("节）和 MCS Connect Response PDU（第"),n("a",{attrs:{href:"https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-rdpbcgr/927de44c-7fe8-4206-a14f-e5517dc24b1c",target:"_blank",rel:"noopener noreferrer"}},[t._v("2.2.1.4"),n("OutboundLink")],1),t._v("节）在客户端和服务器之间交换基本设置。连接初始 PDU 包含一个通用会议控制 (GCC) 会议创建请求，而连接响应 PDU 包含一个 GCC 会议创建响应。这两个 GCC 数据包包含连接的设置数据块（例如核心数据、安全数据和网络数据），由客户端和服务器读取。")]),t._v(" "),n("h4",{attrs:{id:"mcs-connect-initial-pdu"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#mcs-connect-initial-pdu"}},[t._v("#")]),t._v(" MCS Connect Initial PDU")]),t._v(" "),n("p",[t._v("具体参考"),n("a",{attrs:{href:"https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-rdpbcgr/db6713ee-1c0e-4064-a3b3-0fac30b4037b",target:"_blank",rel:"noopener noreferrer"}},[t._v("MCS Connect Initial PDU"),n("OutboundLink")],1)]),t._v(" "),n("div",{staticClass:"language-html line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-html"}},[n("code",[t._v("| tpktHeader | x224Data| mcsCi (variable) |gccCCrq (variable) |clientCoreData (variable)|......|\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br")])]),n("p",[t._v("客户端不同的设置数据有不同的标头，如下表：")]),t._v(" "),n("p",[t._v("The TS_UD_HEADER precedes all data blocks in the client and server GCC user data.")]),t._v(" "),n("table",[n("thead",[n("tr",[n("th",{staticStyle:{"text-align":"left"}},[t._v("Value")]),t._v(" "),n("th",{staticStyle:{"text-align":"left"}},[t._v("Meaning")])])]),t._v(" "),n("tbody",[n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("CS_CORE0xC001")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("The data block that follows contains "),n("a",{attrs:{href:"https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-rdpbcgr/00f1da4a-ee9c-421a-852f-c19f92343d73",target:"_blank",rel:"noopener noreferrer"}},[t._v("Client Core Data"),n("OutboundLink")],1),t._v(" (section 2.2.1.3.2).")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("CS_SECURITY0xC002")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("The data block that follows contains "),n("a",{attrs:{href:"https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-rdpbcgr/6b58e11e-a32b-4903-b736-339f3cfe46ec",target:"_blank",rel:"noopener noreferrer"}},[t._v("Client Security Data"),n("OutboundLink")],1),t._v(" (section 2.2.1.3.3).")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("CS_NET0xC003")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("The data block that follows contains "),n("a",{attrs:{href:"https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-rdpbcgr/49f99e00-caf1-4786-b43c-d425de29a03f",target:"_blank",rel:"noopener noreferrer"}},[t._v("Client Network Data"),n("OutboundLink")],1),t._v(" (section 2.2.1.3.4).")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("CS_CLUSTER0xC004")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("The data block that follows contains "),n("a",{attrs:{href:"https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-rdpbcgr/d68c629f-36a1-4a40-afd0-8b3e56d29aac",target:"_blank",rel:"noopener noreferrer"}},[t._v("Client Cluster Data"),n("OutboundLink")],1),t._v(" (section 2.2.1.3.5).")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("CS_MONITOR0xC005")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("The data block that follows contains Client Monitor Data (section "),n("a",{attrs:{href:"https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-rdpbcgr/a8029f8e-01e1-4f19-af67-bcad5bdef624",target:"_blank",rel:"noopener noreferrer"}},[t._v("2.2.1.3.6"),n("OutboundLink")],1),t._v(").")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("CS_MCS_MSGCHANNEL0xC006")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("The data block that follows contains Client Message Channel Data (section "),n("a",{attrs:{href:"https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-rdpbcgr/f50e791c-de03-4b25-b17e-e914c9020bc3",target:"_blank",rel:"noopener noreferrer"}},[t._v("2.2.1.3.7"),n("OutboundLink")],1),t._v(").")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("CS_MONITOR_EX0xC008")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("The data block that follows contains Client Monitor Extended Data (section "),n("a",{attrs:{href:"https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-rdpbcgr/dfaf8842-c20c-4626-bd3b-8b7d0463bc0f",target:"_blank",rel:"noopener noreferrer"}},[t._v("2.2.1.3.9"),n("OutboundLink")],1),t._v(").")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("CS_MULTITRANSPORT0xC00A")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("The data block that follows contains Client Multitransport Channel Data (section "),n("a",{attrs:{href:"https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-rdpbcgr/3801236b-b5ba-4b6e-bf0d-afbde1fe391c",target:"_blank",rel:"noopener noreferrer"}},[t._v("2.2.1.3.8"),n("OutboundLink")],1),t._v(").")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("SC_CORE0x0C01")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("The data block that follows contains "),n("a",{attrs:{href:"https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-rdpbcgr/379a020e-9925-4b4f-98f3-7d634e10b411",target:"_blank",rel:"noopener noreferrer"}},[t._v("Server Core Data"),n("OutboundLink")],1),t._v(" (section 2.2.1.4.2).")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("SC_SECURITY0x0C02")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("The data block that follows contains "),n("a",{attrs:{href:"https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-rdpbcgr/3e86b68d-3e2e-4433-b486-878875778f4b",target:"_blank",rel:"noopener noreferrer"}},[t._v("Server Security Data"),n("OutboundLink")],1),t._v(" (section 2.2.1.4.3).")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("SC_NET0x0C03")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("The data block that follows contains "),n("a",{attrs:{href:"https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-rdpbcgr/89fa11de-5275-4106-9cf1-e5aa7709436c",target:"_blank",rel:"noopener noreferrer"}},[t._v("Server Network Data"),n("OutboundLink")],1),t._v(" (section 2.2.1.4.4).")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("SC_MCS_MSGCHANNEL0x0C04")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("The data block that follows contains Server Message Channel Data (section "),n("a",{attrs:{href:"https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-rdpbcgr/9269d58a-3d85-48a2-942a-bb0bbe5a55aa",target:"_blank",rel:"noopener noreferrer"}},[t._v("2.2.1.4.5"),n("OutboundLink")],1),t._v(").")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("SC_MULTITRANSPORT0x0C08")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("The data block that follows contains Server Multitransport Channel Data (section "),n("a",{attrs:{href:"https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-rdpbcgr/bf7201d4-9ed9-4dfe-9f6f-f2d68a7367ed",target:"_blank",rel:"noopener noreferrer"}},[t._v("2.2.1.4.6"),n("OutboundLink")],1),t._v(").")])])])]),t._v(" "),n("p",[n("strong",[t._v("length (2 bytes):")]),t._v(" A 16-bit, unsigned integer. The size in bytes of the data block, including this header.")]),t._v(" "),n("img",{staticStyle:{zoom:"40%"},attrs:{src:a(591),alt:"mcs_gcc_req"}}),t._v(" "),n("p",[t._v("相应的链接响应：")]),t._v(" "),n("img",{staticStyle:{zoom:"40%"},attrs:{src:a(592),alt:"x224_01"}}),t._v(" "),n("h4",{attrs:{id:"ts-ud-cs-core"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#ts-ud-cs-core"}},[t._v("#")]),t._v(" TS_UD_CS_CORE")]),t._v(" "),n("p",[t._v("具体参考"),n("a",{attrs:{href:"https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-rdpbcgr/00f1da4a-ee9c-421a-852f-c19f92343d73",target:"_blank",rel:"noopener noreferrer"}},[t._v("TS_UD_CS_CORE"),n("OutboundLink")],1)]),t._v(" "),n("div",{staticClass:"language-html line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-html"}},[n("code",[t._v("| header (4 bytes) | version (4 bytes) | desktopWidth (2 bytes) |desktopheight (2 bytes) |......|\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br")])]),n("p",[t._v("这里携带概述中所提到了基本属性了，报错需要用到的通道名称(cliprdr、rdpsnd、rdpdr)、屏幕宽高、键盘、协商的加密套件协议、色深等等。包括上文提到的对错误信息PDU的支持。不废话，上代码")]),t._v(" "),n("div",{staticClass:"language-rust line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-rust"}},[n("code",[n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"version"')]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("U32")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("::")]),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("LE")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("client_parameter"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("rdp_version "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("u32")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"desktopWidth"')]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("U16")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("::")]),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("LE")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("client_parameter"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("width"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"desktopHeight"')]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("U16")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("::")]),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("LE")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("client_parameter"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("height"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"colorDepth"')]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("U16")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("::")]),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("LE")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ColorDepth")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("::")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("RnsUdColor8BPP")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("u16")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"sasSequence"')]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("U16")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("::")]),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("LE")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Sequence")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("::")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("RnsUdSasDel")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("u16")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"kbdLayout"')]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("U32")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("::")]),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("LE")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("client_parameter"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("layout "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("u32")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"clientBuild"')]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("U32")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("::")]),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("LE")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("18363")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Windows 10, Version 1909, same as FreeRDP")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"clientName"')]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" client_name"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("to_string")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("to_unicode")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"keyboardType"')]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("U32")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("::")]),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("LE")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("KeyboardType")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("::")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Ibm101102Keys")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("u32")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"supportedColorDepths"')]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("U16")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("::")]),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("LE")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//Support::RnsUd15BPPSupport as u16 |")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Support")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("::")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("RnsUd16BPPSupport")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("u16")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//Support::RnsUd24BPPSupport as u16 |")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Support")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("::")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("RnsUd32BPPSupport")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("u16")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"earlyCapabilityFlags"')]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("U16")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("::")]),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("LE")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("capability_flags"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"clientDigProductId"')]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token macro property"}},[t._v("vec!")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("64")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"connectionType"')]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" client_parameter"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("connection_type"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("map")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token closure-params"}},[n("span",{pre:!0,attrs:{class:"token closure-punctuation punctuation"}},[t._v("|")]),t._v("c"),n("span",{pre:!0,attrs:{class:"token closure-punctuation punctuation"}},[t._v("|")])]),t._v("c "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("u8")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("unwrap_or")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"pad1octet"')]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("u8")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"serverSelectedProtocol"')]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("U32")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("::")]),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("LE")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("client_parameter"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("server_selected_protocol"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("...")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("...")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br"),n("span",{staticClass:"line-number"},[t._v("16")]),n("br"),n("span",{staticClass:"line-number"},[t._v("17")]),n("br"),n("span",{staticClass:"line-number"},[t._v("18")]),n("br"),n("span",{staticClass:"line-number"},[t._v("19")]),n("br"),n("span",{staticClass:"line-number"},[t._v("20")]),n("br"),n("span",{staticClass:"line-number"},[t._v("21")]),n("br")])]),n("h4",{attrs:{id:"ts-ud-cs-sec"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#ts-ud-cs-sec"}},[t._v("#")]),t._v(" TS_UD_CS_SEC")]),t._v(" "),n("p",[t._v("具体参考"),n("a",{attrs:{href:"https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-rdpbcgr/6b58e11e-a32b-4903-b736-339f3cfe46ec",target:"_blank",rel:"noopener noreferrer"}},[t._v("TS_UD_CS_SEC "),n("OutboundLink")],1)]),t._v(" "),n("div",{staticClass:"language-html line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-html"}},[n("code",[t._v("| header (4 bytes) | encryptionMethods (4 bytes) | extEncryptionMethods (4 bytes) |extEncryptionMethods |\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br")])]),n("p",[t._v("客户端安全数据主要是客户端支持并与标准 RDP 安全性结合使用的加密方法。客户端必须指定至少一种加密方法，服务器必须选择客户端指定的方法之一。")]),t._v(" "),n("table",[n("thead",[n("tr",[n("th",{staticStyle:{"text-align":"left"}},[t._v("Flag")]),t._v(" "),n("th",{staticStyle:{"text-align":"left"}},[t._v("Meaning")])])]),t._v(" "),n("tbody",[n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("40BIT_ENCRYPTION_FLAG0x00000001")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("40-bit session keys MUST be used to encrypt data (with "),n("a",{attrs:{href:"https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-rdpbcgr/ab35aee7-1cf7-42dc-ac74-d0d7f4ca64f7#gt_d57eac33-f561-4a08-b148-dfcf29cfb4d8",target:"_blank",rel:"noopener noreferrer"}},[t._v("RC4"),n("OutboundLink")],1),t._v(") and generate "),n("a",{attrs:{href:"https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-rdpbcgr/ab35aee7-1cf7-42dc-ac74-d0d7f4ca64f7#gt_3a669297-5242-417e-bff9-5828a186fcf8",target:"_blank",rel:"noopener noreferrer"}},[t._v("Message Authentication Codes (MAC)"),n("OutboundLink")],1),t._v(".")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("128BIT_ENCRYPTION_FLAG0x00000002")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("128-bit session keys MUST be used to encrypt data (with RC4) and generate MACs.")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("56BIT_ENCRYPTION_FLAG0x00000008")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("56-bit session keys MUST be used to encrypt data (with RC4) and generate MACs.")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("FIPS_ENCRYPTION_FLAG0x00000010")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("All encryption and Message Authentication Code generation routines MUST be Federal Information Processing Standard (FIPS) 140-1 compliant.")])])])]),t._v(" "),n("p",[t._v("其他的属性设置这里就不多做介绍了，感兴趣的读者自行研究。不过回过头来看，我们好像没有分析mcsCi这个字段！其实不是博主漏掉了，因为这个变量关联到后面的userdata，也就是属性的设置，所以我们先看属性，再来分析这个变量。")]),t._v(" "),n("h4",{attrs:{id:"mcsci"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#mcsci"}},[t._v("#")]),t._v(" mcsCi")]),t._v(" "),n("p",[t._v("这里要想把这个鬼玩意说清楚，那就必须搬出来 "),n("a",{attrs:{href:"https://go.microsoft.com/fwlink/?LinkId=90543",target:"_blank",rel:"noopener noreferrer"}},[t._v("T125"),n("OutboundLink")],1),t._v(" (section 11.1)了。这个说不清楚，不介绍了。xrdp对这个都没有处理。")]),t._v(" "),n("p",[n("img",{attrs:{src:a(593),alt:"mcsCi01"}})]),t._v(" "),n("h3",{attrs:{id:"ts-ud-cs-multitransport"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#ts-ud-cs-multitransport"}},[t._v("#")]),t._v(" TS_UD_CS_MULTITRANSPORT")]),t._v(" "),n("p",[t._v("rdp当然是封装在tcp/ip协议中的，I/O 通道（[MS-RDPBCGR] 第"),n("a",{attrs:{href:"https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-rdpbcgr/97a697ab-e78b-4c5c-988e-3ece9495b781",target:"_blank",rel:"noopener noreferrer"}},[t._v("3.2.1.3"),n("OutboundLink")],1),t._v(" 和"),n("a",{attrs:{href:"https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-rdpbcgr/693aa241-f6e2-4b86-a3d5-552eecfc2e9d",target:"_blank",rel:"noopener noreferrer"}},[t._v("3.3.1.3"),n("OutboundLink")],1),t._v("节）和可选消息通道（[MS-RDPBCGR] 第 3.2.1.3 和"),n("a",{attrs:{href:"https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-rdpbcgr/55150fac-8dbe-40ee-82c1-ce546f6bcbf7",target:"_blank",rel:"noopener noreferrer"}},[t._v("3.3.1.5"),n("OutboundLink")],1),t._v("节）封装在主 RDP 连接中并使用传输核心 RDP PDU、输入和图形数据。除了这两个通道之外，还有一组协商的静态虚拟通道（[MS-RDPBCGR] 第"),n("a",{attrs:{href:"https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-rdpbcgr/343e4888-4c48-4054-b0e3-4e0762d1993c",target:"_blank",rel:"noopener noreferrer"}},[t._v("1.3.3"),n("OutboundLink")],1),t._v("节）。其中一个名为“DRDYNVC”的静态虚拟通道复用了一组动态虚拟通道（["),n("a",{attrs:{href:"https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-rdpedyc/3bd53020-9b64-4c9a-97fc-90a79e7e1e06",target:"_blank",rel:"noopener noreferrer"}},[t._v("MS-RDPEDYC]"),n("OutboundLink")],1),t._v(" 第"),n("a",{attrs:{href:"https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-rdpedyc/bdbed9f9-ff09-4728-b752-e77365eb38c4",target:"_blank",rel:"noopener noreferrer"}},[t._v("1节"),n("OutboundLink")],1),t._v(", "),n("a",{attrs:{href:"https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-rdpedyc/0147004d-1542-43ab-9337-93338f218587",target:"_blank",rel:"noopener noreferrer"}},[t._v("2"),n("OutboundLink")],1),t._v(" 和"),n("a",{attrs:{href:"https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-rdpedyc/b8642dbe-70b5-4780-ad00-21eb4e08edfb",target:"_blank",rel:"noopener noreferrer"}},[t._v("3"),n("OutboundLink")],1),t._v(" )。")]),t._v(" "),n("p",[t._v("多传输连接通过单独的传输协议运行到主 RDP 连接，并多路复用一组选定的动态虚拟通道。下图说明了 RDP 通道和传输的层次结构和封装。")]),t._v(" "),n("p",[n("img",{attrs:{src:a(594),alt:"TS_UD_CS_MULTITRANSPORT"}})])])}),[],!1,null,null,null);s.default=e.exports}}]);